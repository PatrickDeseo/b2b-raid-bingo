const bingoData = {
  "Kara": {
    "Attumen der Jäger": [
      "Schulterstücke des Jägers",
      "Umhang des Jägers",
      "Schwert des Jägers"
    ],
    "Moroes": [
      "Schleier des Hausmeisters",
      "Dolch des Hausmeisters",
      "Gürtel des Hausmeisters"
    ],
    "Die tugendhafte Maid": [
      "Brustplatte der Tugend",
      "Ring der Tugend",
      "Streitkolben der Tugend"
    ],
    "Opern-Event": [
      "Umhang des großen bösen Wolfs",
      "Stiefel des Unschuldslamms",
      "Ring des großen bösen Wolfs",
      "Schultern des tragischen Helden",
      "Herzförmiger Ring",
      "Langschwert des verbotenen Liebs",
      "Roter Glitzerschuh",
      "Hut des Vogelscheuchenzauberers",
      "Löwenherz-Robe"
    ],
    "Der Kurator": [
      "Schulterstücke des Kurators",
      "Handschuhe des Kurators",
      "Stab des Kurators"
    ],
    "Terestian Siechhuf": [
      "Umhang des Siechhufs",
      "Gürtel des Siechhufs",
      "Stab des Siechhufs"
    ],
    "Schrecken der Nacht": [
      "Brustplatte des Schreckens",
      "Umhang des Schreckens",
      "Schwert des Schreckens"
    ],
    "Schatten von Aran": [
      "Schultern des Schattens",
      "Ring des Schattens",
      "Zauberstab des Schattens"
    ],
    "Netherspite": [
      "Helm des Nethers",
      "Umhang des Nethers",
      "Stab des Nethers"
    ],
    "Schach-Event": [
      "Brustplatte des Königs",
      "Umhang des Königs",
      "Schwert des Königs"
    ],
    "Prinz Malchezaar": [
      "Helm des Prinzen",
      "Umhang des Prinzen",
      "Axt des Prinzen"
    ]
  },
  "ZA": {
    "Akil'zon": [
      "Adlerkralle",
      "Sturmgesegnete Handschuhe",
      "Umhang des gefiederten Zorns"
    ],
    "Nalorakk": [
      "Brustplatte des wilden Bären",
      "Gürtel des ungezähmten Zorns",
      "Schultern des Dschungelwächters"
    ],
    "Jan'alai": [
      "Helm des flammenden Zorns",
      "Beinschützer des Drachenbändigers",
      "Ring der sengenden Hitze"
    ],
    "Halazzi": [
      "Kettenhemd des Geisterkriegers",
      "Armschienen des wilden Geistes",
      "Stab des schleichenden Schattens"
    ],
    "Hexlord Malacrass": [
      "Robe des dunklen Rituals",
      "Klinge des verfluchten Wissens",
      "Talisman der Schattenmacht"
    ],
    "Zul'jin": [
      "Axt des Amani-Kriegshäuptlings",
      "Umhang des Berserkers",
      "Ring des ungebrochenen Willens"
    ]
  },
  "BT": {
    "Oberster Kriegsfürst Naj'entus": [
      "Schuhe des Wellenrufers",
      "Tarnung des Gezeitenlauerers",
      "Mantelung der Dunkelheit",
      "Helm der sanften Ströme",
      "Mukoafäuste",
      "Stiefel des Meereszorns",
      "Eterniumverstärkte Armschienen",
      "Perlenveredelte Stiefel",
      "Schienbeinschützer des Gezeitenstampfers",
      "Ring der friedvollen Wogen",
      "Ring der gebändigten Stürme",
      "Zorn des Mahlstroms",
      "Brausende Flut",
      "Hellebarde der Verwüstung"
    ],
    "Supremus": [
      "Hüfttuch der Unendlichkeit",
      "Netherschattentunika",
      "Bänder des nahenden Sturms",
      "Wickeltücher der meisterlichen Präzision",
      "Schutzgurt des Naturalisten",
      "Schulterstücke des abyssischen Zorns",
      "Halsreif der endlosen Alpträume",
      "Band des abyssischen Lords",
      "Götze des weißen Hirsches",
      "Der Metzler",
      "Entreißer der Nathrezim",
      "Teufelssteinbollwerk",
      "Tod der Legion"
    ],
    "Akamas Schemen": [
      "Amicia des strahlenden Lichts",
      "Angereicherte Manabindungen",
      "Gelenkbänder der göttlichen Einwirkung",
      "Kordel des Schattenwandlers",
      "Kilt der unsterblichen Natur",
      "Schultern des heimlichen Räubers",
      "Geistreisestulpen",
      "Feuerblitzgurt",
      "Handgelenksschützer des Suchers",
      "Handschutz der stillen Gerechtigkeit",
      "Beinschützer des Prätorianers",
      "Myrmidonentreter",
      "Ring der zweifelhaften Absicht",
      "Ikone des blinden Sehers"
    ],
    "Teron Blutschatten": [
      "Zerstörertuch von Schattenmond",
      "Gugel der Gutmütigkeit",
      "Robe des Schattenrats",
      "Heimtückische Bänder",
      "Botanikerhandschuhe des Wachstums",
      "Sanfttrittstiefel des Fährtenlesens",
      "Stulpen der Vollstreckung",
      "Gurt der Gefallenen von Lordaeron",
      "Totem des weisen Rats",
      "Seelenspalter",
      "Verdrehte Klingen des Zarak",
      "Gewehr des besonnenen Wächters"
    ],
    "Relikt der Seelen": [
      "Handschuhe des unermüdlichen Glaubens",
      "Elunitverstärkte Armschienen",
      "Handschutz der Verdammnis",
      "Naturfreundtreter",
      "Mantelung des Wogenheilers",
      "Knochenzwirngurt",
      "Krone des mächtigen Schicksals",
      "Schreckensstiefel der Legion",
      "Durchsichtige Zauberfadenhalskette",
      "Anhänger der Titanen",
      "Beflügelnde Berührung",
      "Fackel der Verdammten",
      "Naarugesegneter Lebensstab"
    ],
    "Gurtogg Siedeblut": [
      "Schleier der Vergebung",
      "Schulterpolster des Blutfluchs",
      "Gewänder der Mäßigung",
      "Gürtel der reinen Anmut",
      "Weste des wachsenden Ansturms",
      "Gurt der mächtigen Entschlossenheit",
      "Gurt der Stabilität",
      "Gamaschen der göttlichen Vergeltung",
      "Unaufhaltsamer Ring des Aggressors",
      "Insigne des Schattenmondklans",
      "Schicksalsbote",
      "Stab der vollständigen Genesung",
      "Zauberstab des prismatischen Kerns"
    ],
    "Mutter Shahraz": [
      "Gamaschen der Verwüstung",
      "Schattenmeisterstiefel",
      "Brustplatte des Herzreißers",
      "Nadinas Anhänger der Reinheit",
      "Foliant des Lichtbringers",
      "Klinge der Unbändigkeit"
    ],
    "Mutter Shahraz Tokens": [
      "Schulterstücke des vergessenen Eroberers",
      "Schulterstücke des vergessenen Beschützers",
      "Schulterstücke des vergessenen Bezwingers"
    ],
    "Der Rat der Illidari": [
      "Ratsumhang der Illidari",
      "Gürtel des göttlichen Rats",
      "Schleier der sich wendenen Blätter",
      "Helm des Waldstreichers",
      "Helm des Illidarivernichters",
      "Wahnsinn des Verräters"
    ],
    "Der Rat der Illidari Tokens": [
      "Gamaschen des vergessenen Eroberers",
      "Gamaschen des vergessenen Beschützers",
      "Gamaschen des vergessenen Bezwingers"
    ],
    "Illidan Sturmgrimm": [
      "Tuch des Hochgeborenen",
      "Gugel des Illidarihochfürsten",
      "Verfluchter Blick des Sargeras",
      "Gesichtsschutz des Undurchdringlichen",
      "Sturmgrimms Siegelring",
      "Der Schädel des Gul'dan",
      "Tyrandes Andenken",
      "Splitter von Azzinoth",
      "Kristallspitze von Karabor",
      "Zhar'doom, Großstab des Verschlingers",
      "Bollwerk von Azzinoth",
      "Schwarzer Bogen des Verräters"
    ],
    "Illidan Sturmgrimm Tokens": [
      "Brustschutz des vergessenen Eroberers",
      "Brustschutz des vergessenen Beschützers",
      "Brustschutz des vergessenen Bezwingers"
    ]
  },
  "SSC": {
    "Hydross der Unstete": [
      "Robe der verhassten Echos",
      "Wickeltücher der Läuterung",
      "Stiefel des unbeständigen Alptraums",
      "Schulterpolster des Fremden",
      "Kriegsbänder der Tiefschwarzen Grotte",
      "Brustschutz des Waldläufergenerals",
      "Prunkhelm des gerechten Urteils",
      "Schulterstücke des Kriegstänzers",
      "Ring der Tödlichkeit",
      "Band der ruchlosen Aggression",
      "Lebendige Wurzel des Wildherzens",
      "Skarabäus der Verdrängung",
      "Tiefenstein",
      "Götze der Halbmondgöttin"
    ],
    "Das Grauen aus der Tiefe": [
      "Kordel des gellenden Schreckens",
      "Samtstiefel des Wächters",
      "Hainbänder von Remulos",
      "Stiefel des mühelosen Kampfes",
      "Stiefel des Orkanschreiters",
      "Leuchtende Brustplatte der Wahrheit",
      "Armschienen des Blutbads",
      "Halsreif des lebendigen Zorns",
      "Ahnenring der Eroberung",
      "Das Siegel von Danzalar",
      "Ohrring der seelenvollen Meditation",
      "Buchband der absoluten Wahrheit",
      "Schlaghammer der Gezeiten"
    ],
    "Leotheras der Blinde": [
      "Stiefel aus Orcahaut",
      "Stachelige Korallenschulterpolster",
      "Pirscherbänder des sicheren Ziels",
      "Tsunamitalisman",
      "Reißzahn des Leviathans"
    ],
    "Leotheras der Blinde Tokens": [
      "Handschuhe des bezwungenen Champions",
      "Handschuhe des bezwungenen Verteidigers",
      "Handschuhe des bezwungenen Helden"
    ],
    "Tiefenlord Karathress": [
      "Stiefel des Seelenwandlers",
      "Brigantenweste der blutigen See",
      "Ausgefranster Strick des Ertrunkenen",
      "Tiefenbrosche des Gezeitenwandlers",
      "Sextant der unsteten Strömung",
      "Weltenbrecher"
    ],
    "Tiefenlord Karathress Tokens": [
      "Gamaschen des bezwungenen Champions",
      "Gamaschen des bezwungenen Verteidigers",
      "Gamaschen des bezwungenen Helden"
    ],
    "Morogrim Gezeitenwandler": [
      "Rauer Schuppenkampfumhang",
      "Schulterpolster der Illidari",
      "Rauer Brustharnisch der Uralten",
      "Mantelung des rastlosen Fährtenlesers",
      "Gurt des Gezeitenrufs",
      "Schulterstücke der Argentumschildwache",
      "Kriegsstiefel der Auslöschung",
      "Anhänger der verlorenen Zeiten",
      "Ring der gemarterten Seelen",
      "Band des Wachsamen",
      "Flechte der Schlangenschlinge",
      "Kralle von Azshara",
      "Flimmernde Rute der Naaru"
    ],
    "Lady Vashj": [
      "Gewand der Meerhexe",
      "Runentotems Mantelung",
      "Gürtel der hundert Tode",
      "Kobraschlingenstiefel",
      "Krakkenherzbrustplatte",
      "Stulpen von Wappenfall",
      "Ring der Endlosschleife",
      "Korallenband des Wiederbelebten",
      "Prisma der inneren Ruhe",
      "Vashjs Fangzahn",
      "Szepter der Lichtertiefe",
      "Langbogen des Schlangenrückens"
    ],
    "Lady Vashj Token": [
      "Helm des bezwungenen Champions",
      "Helm des bezwungenen Verteidigers",
      "Helm des bezwungenen Helden"
    ]
  }
};

// Seeded Random (xorshift)
function seededRandom(seed) {
  return () => {
    seed ^= seed << 13;
    seed ^= seed >> 17;
    seed ^= seed << 5;
    return Math.abs(seed % 10000) / 10000;
  };
}

// Deterministisches Shuffle
function shuffleWithSeed(array, rand) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function generateGridFromSeed(topic, size, seed) {
  const data = bingoData[topic];
  if (!data) return null;

  const rand = seededRandom(seed);
  const tasks = [];
  for (const [person, list] of Object.entries(data)) {
    list.forEach(text => tasks.push({ person, text }));
  }

  shuffleWithSeed(tasks, rand);

  const grid = Array.from({ length: size }, () => Array(size).fill(null));
  const rowCounts = Array.from({ length: size }, () => ({}));
  const colCounts = Array.from({ length: size }, () => ({}));

  for (let r = 0; r < size; r++) {
    for (let c = 0; c < size; c++) {
      let placed = false;

      for (let i = 0; i < tasks.length; i++) {
        console.log("Tasks.length " + tasks.length);
        console.log("i= " + i);
        const { person, text } = tasks[i];
        const rowCount = rowCounts[r][person] || 0;
        const colCount = colCounts[c][person] || 0;

        if (rowCount < 1 && colCount < 1) {
          grid[r][c] = { person, text };
          rowCounts[r][person] = rowCount + 1;
          colCounts[c][person] = colCount + 1;
          tasks.splice(i, 1);
          placed = true;
          break;
        }
      }

      if (!placed) return null;
    }
  }
  
  return grid;
}

function renderGrid(grid, size) {
  const board = document.getElementById("bingoBoard");
  board.innerHTML = "";
  board.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

  grid.flat().forEach(({ person, text }) => {
    const cell = document.createElement("div");
    cell.className = "bingo-cell";
    cell.innerHTML = `
      <div class="task-text">${text}</div>
      <div class="person-text">${person}</div>
    `;
    cell.addEventListener("click", () => {
      cell.classList.toggle("done");
    });
    board.appendChild(cell);
  });
}

// Dropdown befüllen
const selector = document.getElementById("arraySelector");
Object.keys(bingoData).forEach(key => {
  const option = document.createElement("option");
  option.value = key;
  option.textContent = key;
  selector.appendChild(option);
});

// Button → Zettel generieren
document.getElementById("generateBtn").addEventListener("click", () => {
  const topic = selector.value;
  const total = Object.values(bingoData[topic]).flat().length;

  let size = 3;
  if (total >= 25) size = 5;
  else if (total >= 16) size = 4;

  const seed = Math.floor(Math.random() * 1000000);
  document.getElementById("codeInput").value = `${topic}:${size}:${seed}`;

  const grid = generateGridFromSeed(topic, size, seed);
  if (grid) renderGrid(grid, size);
  else alert("❌ Fehler beim Generieren");
});

// Button → Code eingeben & laden
document.getElementById("validateBtn").addEventListener("click", () => {
  const input = document.getElementById("codeInput").value.trim();
  const [topic, sizeStr, seedStr] = input.split(":");
  const size = parseInt(sizeStr, 10);
  const seed = parseInt(seedStr, 10);

  if (!bingoData[topic] || !size || isNaN(seed)) {
    alert("❌ Ungültiger Code");
    return;
  }

  const grid = generateGridFromSeed(topic, size, seed);
  if (grid) renderGrid(grid, size);
  else alert("❌ Zettel konnte nicht wiederhergestellt werden");
});